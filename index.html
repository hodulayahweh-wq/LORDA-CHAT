<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lord AI Singularity</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f0f17; --surface:#1a1f2e; --text:#e0e7ff; --accent:#7c3aed; --user:#4f46e5; --error:#ef4444; }
    body { margin:0; font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; }
    header { padding:1rem; background:var(--surface); text-align:center; position:sticky; top:0; z-index:10; border-bottom:1px solid #2d3748; }
    .logo { font-size:1.6rem; font-weight:700; color:var(--accent); }
    main { flex:1; max-width:900px; margin:0 auto; width:100%; padding:1rem 0.8rem; display:flex; flex-direction:column; }
    #messages { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:1rem; padding-bottom:1rem; }
    .message { max-width:90%; padding:1rem 1.2rem; border-radius:1.2rem; line-height:1.5; }
    .message.user { align-self:flex-end; background:var(--user); color:white; border-bottom-right-radius:0.4rem; }
    .message.ai, .loading { align-self:flex-start; background:var(--surface); border:1px solid #2d3748; border-bottom-left-radius:0.4rem; }
    .error { align-self:center; background:rgba(239,68,68,0.15); color:var(--error); border:1px solid rgba(239,68,68,0.4); text-align:center; }
    .input-area { background:var(--surface); border-top:1px solid #2d3748; padding:0.8rem; display:flex; gap:0.6rem; position:sticky; bottom:0; }
    #input { flex:1; padding:0.9rem 1.2rem; border:1px solid #2d3748; border-radius:999px; background:var(--bg); color:var(--text); font-size:1.05rem; outline:none; }
    #input:focus { border-color:var(--accent); }
    #send { padding:0.9rem 1.6rem; background:var(--accent); color:white; border:none; border-radius:999px; font-weight:600; cursor:pointer; }
    #send:disabled { opacity:0.5; cursor:not-allowed; }
    footer { padding:1rem; text-align:center; background:var(--surface); border-top:1px solid #2d3748; font-size:0.9rem; }
    footer a { color:var(--accent); margin:0 1rem; text-decoration:none; }
    footer a:hover { text-decoration:underline; }
  </style>
</head>
<body>

  <header><div class="logo">Lord AI Singularity</div></header>

  <main>
    <div id="messages">
      <div class="message ai">Merhaba! Ne sormak istersin? üöÄ</div>
    </div>

    <div class="input-area">
      <input id="input" placeholder="Yaz bakalƒ±m..." autocomplete="off" autofocus/>
      <button id="send">G√∂nder</button>
    </div>
  </main>

  <footer>
    <a href="https://t.me/lordsystemv3" target="_blank">üì¢ Kanal</a>
    <a href="https://t.me/LordDestekHat" target="_blank">üõ†Ô∏è Destek</a>
  </footer>

  <script>
    const API_URL = "https://lordageichatsohbet.onrender.com/api";
    const API_KEY = "LORD-BB8B7004";

    const messages = document.getElementById("messages");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");

    function addMessage(text, type = "ai") {
      const div = document.createElement("div");
      div.className = `message ${type}`;
      div.innerHTML = text.replace(/\n/g, "<br>");
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function showError(msg) {
      addMessage(msg, "error");
    }

    async function sendMessage() {
      const query = input.value.trim();
      if (!query) return;

      addMessage(query, "user");
      input.value = "";
      sendBtn.disabled = true;

      const loading = document.createElement("div");
      loading.className = "message loading";
      loading.textContent = "Biraz bekleyin, sunucumuz aƒüƒ±r √ßalƒ±≈üƒ±yor...";
      messages.appendChild(loading);
      messages.scrollTop = messages.scrollHeight;

      const MAX_RETRIES = 5; // artƒ±rdƒ±m, daha toleranslƒ±
      let attempt = 0;

      while (attempt < MAX_RETRIES) {
        attempt++;
        try {
          const url = `\( {API_URL}?key= \){API_KEY}&q=${encodeURIComponent(query)}`;
          console.log(`Deneme ${attempt}: ${url}`);

          const res = await fetch(url, { cache: "no-store" });

          console.log(`Status: ${res.status}`);

          if (!res.ok) {
            if ([404, 503, 504].includes(res.status) && attempt < MAX_RETRIES) {
              loading.textContent = `Sunucu hazƒ±rlanƒ±yor, biraz bekleyin... (\( {attempt}/ \){MAX_RETRIES})`;
              await new Promise(r => setTimeout(r, 5000)); // 5 sn
              continue;
            }
            throw new Error(`Sunucu hatasƒ±: ${res.status}`);
          }

          const raw = await res.text();
          console.log("Ham cevap:", raw.substring(0, 300)); // debug

          let data;
          try {
            data = JSON.parse(raw.trim().replace(/^\uFEFF/, ''));
          } catch (parseErr) {
            console.error("Parse hatasƒ±:", parseErr);
            throw new Error("Cevap bozuk geldi");
          }

          loading.remove();

          if (data.status === "success" && data.response) {
            addMessage(data.response, "ai");
            sendBtn.disabled = false;
            input.focus();
            return;
          } else if (data.error) {
            showError("API Hatasƒ±: " + data.error);
            break;
          } else {
            showError("Beklenmedik format");
            break;
          }

        } catch (err) {
          console.error("Hata:", err);
          if (attempt === MAX_RETRIES) {
            loading.remove();
            showError("Sunucuya ula≈üƒ±lamƒ±yor. Render yava≈ü uyanƒ±yor olabilir veya key/bakiye sorunu var. Telegram'a bak.");
          }
        }
      }

      sendBtn.disabled = false;
      input.focus();
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
